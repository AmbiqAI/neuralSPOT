<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.2"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Ambiq NeuralSPOT: NeuralSPOT Developer&#39;s Guide</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
  $(document).ready(function() { init_search(); });
/* @license-end */
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="am_intelligence.png"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Ambiq NeuralSPOT<span id="projectnumber">&#160;Beta</span>
   </div>
   <div id="projectbrief">NeuralSPOT is Ambiq&#39;s collection of AI libraries and tools</div>
  </td>
    <td>        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.svg"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.svg" alt=""/></a>
          </span>
        </div>
</td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.2 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search",'Search','.html');
/* @license-end */
</script>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('md___users_carlosmorales__ambiq_dev_neural_s_p_o_t_docs_developer_guide.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">NeuralSPOT Developer's Guide </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p >This document covers various guidelines for creating and modifying NeuralSPOT's various types of components. Its intended audience are NeuralSPOT developers and contributors.</p>
<h1><a class="anchor" id="autotoc_md1"></a>
FAQs</h1>
<h4><a class="anchor" id="autotoc_md2"></a>
Where is main()?</h4>
<p >NeuralSPOT [examples]() each contain a <code><a class="el" href="main_8cc.html#a840291bc02cba5474a4cb46a9b9566fe" title="Main function - infinite loop listening and inferring.">main()</a></code>, and each example produces a different binary.</p>
<h4><a class="anchor" id="autotoc_md3"></a>
Where are the linker script and reset handlers?</h4>
<p >NeuralSPOT uses the AmbiqSuite <a href="https://github.com/AmbiqAI/neuralSPOT/blob/main/extern/AmbiqSuite/R4.1.0/src/linker_script.ld">linker script</a> and <a href="https://github.com/AmbiqAI/neuralSPOT/blob/main/extern/AmbiqSuite/R4.1.0/src/startup_gcc.c">startup_gcc</a> (which defines reset handlers, vector tables, etc.).</p>
<h4><a class="anchor" id="autotoc_md4"></a>
How do the makefiles work?</h4>
<p >This is documented in the <a href="https://github.com/AmbiqAI/neuralSPOT/blob/main/Makefile">main makefile</a>.</p>
<h1><a class="anchor" id="autotoc_md5"></a>
Adding Components to NeuralSPOT</h1>
<p >This section describes the process and structure for adding components to NeuralSPOT. Types of NeuralSPOT components include:</p>
<ol type="1">
<li>NeuralSPOT Libraries</li>
<li>NeuralSPOT Examples</li>
<li>External Components</li>
<li>RPC Interfaces</li>
</ol>
<h2><a class="anchor" id="autotoc_md6"></a>
Adding NeuralSPOT Library Components</h2>
<p >NeuralSPOT Libraries are small, task-specific components. They're located in <code>./neuralspot</code>, and are generally organized by function. For example, current components include ns-audio, ns-ipc, ns-i2c, ns-rpc, and so on. Some libraries are collections of very simple functions - ns_peripherals includes both ns-power and ns-button, components which are too simple to warrant their on libraries.</p>
<p >Each library compiles to a static lib (e.g. <code>ns-audio.a</code>), and has a defined API (e.g. <code>ns-audio.h</code>). When linking, only code which is invoked is actually linked into the binary.</p>
<h3><a class="anchor" id="autotoc_md7"></a>
Library Component Structure</h3>
<p >Every neuralspot library has a similar structure - some of this is dictated by neuralspot's makefile architecture, and some is by convention. The typical structure is as follows:</p>
<div class="fragment"><div class="line">./neuralspot/</div>
<div class="line">    ns-&lt;componentName&gt;/</div>
<div class="line">        src/         # All c/cc/cpp/s/h/hpp files in here will be compiled to a static library</div>
<div class="line">        include_api/ # H/HPP files defining APIs for library - files in here will be added to -I compiler path</div>
<div class="line">        module.mk    # Simple makefile (see boilerplate below)</div>
<div class="line">        ns-&lt;componentName&gt;.md # Local documentation</div>
<div class="line">        build/       # temporary working directory for storing static libs, object files and other compile artifacts</div>
</div><!-- fragment --><h3><a class="anchor" id="autotoc_md8"></a>
Library Component Module definition</h3>
<p >Each component includes a local <code>module.mk</code>. These are fairly similar in structure, and tend to follow this pattern:</p>
<div class="fragment"><div class="line">local_src := $(wildcard $(subdirectory)/src/*.c)</div>
<div class="line">local_src += $(wildcard $(subdirectory)/src/*.cpp)</div>
<div class="line">local_src += $(wildcard $(subdirectory)/src/*.cc)</div>
<div class="line">local_src += $(wildcard $(subdirectory)/src/*.s)</div>
<div class="line">includes_api += $(subdirectory)/includes-api</div>
<div class="line"> </div>
<div class="line">local_bin := $(subdirectory)/$(BINDIR)</div>
<div class="line">bindirs   += $(local_bin)</div>
<div class="line">$(eval $(call make-library, $(local_bin)/ns-&lt;componentName&gt;.a, $(local_src))) # only change needed</div>
</div><!-- fragment --><p> The only thing that normally differs between library's <code>module.mk</code> is the <code>&lt;componentName&gt;</code></p>
<h2><a class="anchor" id="autotoc_md9"></a>
Adding NeuralSPOT Examples</h2>
<p >NeuralSPOT Examples are pared-down examples showcasing NueralSPOT functionality. They contain the application's <a class="el" href="main_8cc.html#a840291bc02cba5474a4cb46a9b9566fe" title="Main function - infinite loop listening and inferring.">main()</a> function which typically initializes everthing and then executes the application loop.</p>
<p >For every Example, NeuralSPOT will compile all the binary artifacts needed to load the application onto an EVB, such as main.axf, main.bin, and so on. These artifacts are stored in the example's temporary build directory.</p>
<blockquote class="doxtable">
<p ><b>Note</b> The name of the artifact is derived from the example's <code>module.mk</code> not the directory it resides in. </p>
</blockquote>
<h3><a class="anchor" id="autotoc_md10"></a>
Example Component Structure</h3>
<p >Every neuralspot library has a similar structure - some of this is dictated by neuralspot's makefile architecture, and some is by convention. The typical structure is as follows:</p>
<div class="fragment"><div class="line">./examples/</div>
<div class="line">    &lt;exampleName&gt;/</div>
<div class="line">        src/             # All c/cc/cpp/s/h/hpp files in here will be compiled to a flashable file</div>
<div class="line">        module.mk        # Simple makefile (see boilerplate below)</div>
<div class="line">        &lt;exampleName&gt;.md # Local documentation</div>
</div><!-- fragment --><h3><a class="anchor" id="autotoc_md11"></a>
Example Component Module definition</h3>
<p >Each component includes a local <code>module.mk</code>. These are fairly similar in structure, and tend to follow this pattern:</p>
<div class="fragment"><div class="line">local_app_name := &lt;exampleArtifactName&gt;   # Must match name of src file containing main, e.g. &quot;rpc&quot; if main is in &quot;rpc.cc&quot;</div>
<div class="line">local_src := $(wildcard $(subdirectory)/src/*.c)</div>
<div class="line">local_src += $(wildcard $(subdirectory)/src/*.cc)</div>
<div class="line">local_src += $(wildcard $(subdirectory)/src/*.cpp)</div>
<div class="line">local_src += $(wildcard $(subdirectory)/src/*.s)</div>
<div class="line">local_bin := $(subdirectory)/$(BINDIR)</div>
<div class="line"> </div>
<div class="line">bindirs   += $(local_bin)</div>
<div class="line">sources   += $(local_src)</div>
<div class="line">examples  += $(local_bin)/$(local_app_name).axf</div>
<div class="line">examples  += $(local_bin)/$(local_app_name).bin</div>
<div class="line">mains     += $(local_bin)/$(local_app_name).o</div>
</div><!-- fragment --><p >Except for first line, this is all boilerplate.</p>
<h2><a class="anchor" id="autotoc_md12"></a>
Adding External Component</h2>
<p >External components are any component that may be needed by NeuralSPOT, but aren't a part of it. External components include things like AmbiqSuite, Tensorflow Lite for Microcontrollers, and Embedded RPC.</p>
<p >The structure of an external component included in NeuralSPOT depends on the component - for example, <code>extern/AmbiqSuite</code> doesn't include all of the SDK, instead including only the necessary header files, static libraries, and bare minimum of source files needed to compile.</p>
<p >NeuralSPOT will support multiple versions of external components. These are stored in different subdirectories under the external component directory, and are selected by makefile flags in <code>make/neuralspot_config.mk</code>.</p>
<h3><a class="anchor" id="autotoc_md13"></a>
External Component Structure</h3>
<p >Generally, the structure of an external component within NeuralSPOT is: </p><div class="fragment"><div class="line">.../extern/</div>
<div class="line">    &lt;componentName&gt;/</div>
<div class="line">        &lt;version&gt;/</div>
<div class="line">            lib/   # Contains static libraries if there are any</div>
<div class="line">            src/   # source and header files</div>
<div class="line">            module.mk</div>
</div><!-- fragment --><p >Because external components don't have a well-defined structure, the module.mk is less boilerplate than that of other types of components. The critical parts of a typical module.mk are:</p><ol type="1">
<li>Defining the local source files that need compilation</li>
<li>Add required header files to <code>includes_api</code></li>
<li>Adding any pre-built static libraries to <code>lib_prebuilt</code></li>
<li>If the component generates object files, they need to be linked into a static library via the <code>make-library</code> makefile function.</li>
</ol>
<h3><a class="anchor" id="autotoc_md14"></a>
External Component Module Definition</h3>
<p >Here is a simple example which adds tensorflow to NeuralSPOT: </p><div class="fragment"><div class="line">includes_api += $(subdirectory)/tensorflow</div>
<div class="line">includes_api += $(subdirectory)/third_party</div>
<div class="line">includes_api += $(subdirectory)/third_party/flatbuffers/include</div>
<div class="line"> </div>
<div class="line">lib_prebuilt += $(subdirectory)/lib/libtensorflow-microlite.a</div>
</div><!-- fragment --><p >On the other hand, here is AmbiqSuite's module.mk: </p><div class="fragment"><div class="line"># Add source files</div>
<div class="line">local_src := $(wildcard $(subdirectory)/src/*.c)</div>
<div class="line">local_src += $(wildcard $(subdirectory)/src/*.cc)</div>
<div class="line">local_src += $(wildcard $(subdirectory)/src/*.s)</div>
<div class="line"> </div>
<div class="line"># Base AmbiqSuite include files (note the $ variables)</div>
<div class="line">includes_api += $(subdirectory)/boards/$(BOARD)_$(EVB)/bsp</div>
<div class="line">includes_api += $(subdirectory)/CMSIS/ARM/Include</div>
<div class="line">includes_api += $(subdirectory)/CMSIS/AmbiqMicro/Include</div>
<div class="line">includes_api += $(subdirectory)/devices</div>
<div class="line">includes_api += $(subdirectory)/mcu/$(BOARD)</div>
<div class="line">includes_api += $(subdirectory)/mcu/$(BOARD)/hal/mcu</div>
<div class="line">includes_api += $(subdirectory)/utils</div>
<div class="line"> </div>
<div class="line"># Pre-built static libraries</div>
<div class="line">lib_prebuilt += $(subdirectory)/lib/$(PART)/libam_hal.a</div>
<div class="line">lib_prebuilt += $(subdirectory)/lib/$(PART)/$(EVB)/libam_bsp.a</div>
<div class="line">lib_prebuilt += $(subdirectory)/lib/libarm_cortexM4lf_math.a</div>
<div class="line"> </div>
<div class="line"># Third-Party (FreeRTOS)</div>
<div class="line">includes_api += $(subdirectory)/third_party/FreeRTOSv10.1.1/Source/include</div>
<div class="line">includes_api += $(subdirectory)/third_party/FreeRTOSv10.1.1/Source/portable/GCC/AMapollo4</div>
<div class="line"> </div>
<div class="line"># Third-Party (TinyUSB)</div>
<div class="line">includes_api += $(subdirectory)/third_party/tinyusb/src</div>
<div class="line">includes_api += $(subdirectory)/third_party/tinyusb/src/common</div>
<div class="line">includes_api += $(subdirectory)/third_party/tinyusb/src/osal</div>
<div class="line">includes_api += $(subdirectory)/third_party/tinyusb/src/class/cdc</div>
<div class="line">includes_api += $(subdirectory)/third_party/tinyusb/src/device</div>
<div class="line"> </div>
<div class="line">local_bin := $(subdirectory)/$(BINDIR)</div>
<div class="line">bindirs   += $(local_bin)</div>
<div class="line"> </div>
<div class="line"># Special link and compiler overrides</div>
<div class="line">LINKER_FILE := $(subdirectory)/src/linker_script.ld</div>
<div class="line">STARTUP_FILE := ./startup_$(COMPILERNAME).c</div>
<div class="line"> </div>
<div class="line">$(eval $(call make-library, $(local_bin)/ambiqsuite.a, $(local_src)))</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md15"></a>
Adding RPC Interfaces</h2>
<blockquote class="doxtable">
<p ><b>LIMITATIONS</b> ns-rpc only works as client or server, exclusively. </p>
</blockquote>
<p>RPC (Remote Procedure Call) interfaces are a way to 'call' functions that reside on another CPU (in NeuralSPOT's case, on another computer entirely). Adding an RPC interface is a fairly complex process involving:</p>
<ol type="1">
<li>Defining the interface using an IDL (interface definition language)</li>
<li>Processing that definition to generate server and client code.</li>
<li>Copying the generated client code to neuralSPOT, generally as a new neuralspot library</li>
<li>Implementing the server code that will respond to the client.</li>
</ol>
<p >NeuralSPOT RPC is based on <a href="https://github.com/AmbiqAI/erpc">a modified fork</a> of <a href="https://github.com/EmbeddedRPC/erpc">EmbeddedRPC (eRPC)</a> which supports RPC-over-TinyUSB on our EVBs. How eRPC works, including the <a href="https://github.com/EmbeddedRPC/erpc/wiki/IDL-Reference">specifics of IDL definition</a>, is outside the scope of this document.</p>
<h3><a class="anchor" id="autotoc_md16"></a>
RPC Structure</h3>
<p >RPC in NeuralSPOT is structured as follows:</p>
<ol type="1">
<li>The relevant parts of eRPC's infrastructure reside in <code>extern/erpc</code></li>
<li>Interface library implementations reside in <code>neuralspot/ns-rpc</code></li>
<li>Examples of generic RPC utilization reside in <code>examples/rpc-client</code>, and<code>examples/rpc-server</code>.</li>
<li>Examples of practical utilization of RPC to capture data can be found in <code>examples/har</code> (for i2c) and <code>examples/basic_tf_stub</code> (for audio)</li>
</ol>
<h4><a class="anchor" id="autotoc_md17"></a>
NS-RPC Structure</h4>
<div class="fragment"><div class="line">ns-rpc/</div>
<div class="line">    interfaces/ # contains IDL definition files</div>
<div class="line">    includes-api/ # API for each interface</div>
<div class="line">    python/ # PC-side code implementing the interface and example client/servers using it</div>
<div class="line">    src/ # Code implementing the interface and wrapping it for neuralspot</div>
</div><!-- fragment --><h3><a class="anchor" id="autotoc_md18"></a>
Creating a New Interface</h3>
<p >As briefly described above, creating a new interface involves multiple steps, some of which generate CPP and Python code that need to be wrapped usefully for integration with NeuralSPOT.</p>
<h4><a class="anchor" id="autotoc_md19"></a>
Step 1 - Defining the Interface</h4>
<p >eRPC definitions start from an ERPC file which is written in an IDL (defined <a href="https://github.com/EmbeddedRPC/erpc/wiki/IDL-Reference">here</a>). eRPC doesn't have a lot of good examples in the wild, so we recommend you start from an existing definition such as <a href="https://github.com/AmbiqAI/neuralSPOT/blob/main/neuralspot/ns-rpc/interfaces/GenericDataOperations.erpc"><code>GenericDataOperations.erpc</code></a>.</p>
<h4><a class="anchor" id="autotoc_md20"></a>
Step 2 - Generating the code</h4>
<p >eRPC can generate both C and Python client and server code (of course, the Python code is only for use on the PC). You only have to generate Python if you plan on implementing Python-based PC applications. Currently, NeuralSPOT only includes Python PC examples.</p>
<div class="fragment"><div class="line">$&gt; cd neuralspot/ns-rpc</div>
<div class="line">$&gt; mkdir python/foo</div>
<div class="line">$&gt; erpcgen -g py -o python/foo interfaces/foo.erpc # Generate Python client/server code</div>
<div class="line">$&gt; erpcgen -o src interfaces/foo.erpc # Generate C client/server code</div>
</div><!-- fragment --><blockquote class="doxtable">
<p ><b>NOTE</b> The Client C code contains prototypes for the remote procedures. This will cause linking errors if you are not implementing those procedures. If you don't plan on implementing EVB-side client procedures, delete the file or give it a non-source extension to avoid compiling it. </p>
</blockquote>
<p>At this point you'll have everything you need to implement the interface.</p>
<h4><a class="anchor" id="autotoc_md21"></a>
Step 3 - Wrap the Interface</h4>
<p >When the EVB is acting as a client (i.e. it is calling procedures that reside on the PC), all you really need to do is add an <code>init()</code> and a header file that includes everything needed for the application to find the remote procedures. The <code>init()</code> should initialize the USB interface and the erpc client.</p>
<p >When the EVB is acting as a server, the <code>ns-rpc</code> wrapper should also include implementations for the remotely called procedures. One way to implement this is to have those procedures invoke callbacks, which can be defined via the <code>init()</code>.</p>
<p >See the GenericDataOperations <a href="https://github.com/AmbiqAI/neuralSPOT/blob/main/neuralspot/ns-rpc/src/ns_rpc_generic_data.c">wrapper</a> for an example of how to wrap both client and server interfaces.</p>
<h4><a class="anchor" id="autotoc_md22"></a>
Step 4 - Write a PC-side RPC application</h4>
<p >Your new interface will need a PC-side application (server or client, depending on your needs). NeuralSPOT includes <a href="https://github.com/AmbiqAI/neuralSPOT/blob/main/neuralspot/ns-rpc/python/ns-rpc-genericdata/generic_data.py">an example PC side application</a> that can be configured as either a server or client. The code is fairly self-explanatory.</p>
<blockquote class="doxtable">
<p ><b>Note</b> that the eRPC Python implementation is not well documented or tested. NeuralSPOT's GenericDataOperation RPC interface has been tested to work well after fixing a few bugs in our eRPC fork, but other types of interfaces have not be stressed. </p>
</blockquote>
<h3><a class="anchor" id="autotoc_md23"></a>
Modifying an Existing Interface</h3>
<p >Modifying an interface involves changing the existing interface's eRPC file, generating new interface files, and modifying the wrappers to accomodate those changes. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.2 </li>
  </ul>
</div>
</body>
</html>
