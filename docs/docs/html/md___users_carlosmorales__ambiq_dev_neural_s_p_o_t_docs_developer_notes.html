<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.2"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Ambiq NeuralSPOT: WIP Notes (Pay no attention to anything below this line)</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
  $(document).ready(function() { init_search(); });
/* @license-end */
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="am_intelligence.png"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Ambiq NeuralSPOT<span id="projectnumber">&#160;Beta</span>
   </div>
   <div id="projectbrief">NeuralSPOT is Ambiq&#39;s collection of AI libraries and tools</div>
  </td>
    <td>        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.svg"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.svg" alt=""/></a>
          </span>
        </div>
</td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.2 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search",'Search','.html');
/* @license-end */
</script>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('md___users_carlosmorales__ambiq_dev_neural_s_p_o_t_docs_developer_notes.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">WIP Notes (Pay no attention to anything below this line) </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1><a class="anchor" id="autotoc_md15"></a>
Adding malloc support</h1>
<p >Malloc support is non-deterministic, and should only be used for debug environments such as erpc</p>
<p >It has 3 components</p><ol type="1">
<li>ns-malloc</li>
<li>example/basic_tf_stub modified to include it</li>
<li>ns-harness maps standard malloc/etc to ns-malloc equivalents</li>
</ol>
<h2><a class="anchor" id="autotoc_md16"></a>
Status</h2>
<p >Added malloc and usb to ambiqsuite.a Created ns-usb with init, send, and rx routines Next</p><ol type="1">
<li>create ns-util malloc stuff, get it compiling (should be easy wrapper around freertos malloc) (DONE)</li>
<li>Create new nest in erpc, taking care to not obliterate work in current nest (DONE)</li>
<li>Modify erpc transport code to use all of the above</li>
<li>Test in <a class="el" href="main_8cc.html" title="Speech-to-Intent using NeuralSPOT.">main.cc</a></li>
</ol>
<h2><a class="anchor" id="autotoc_md17"></a>
New Next</h2>
<p >Did 1, 2, 3, and a bit of 4 (don't really have a usb test). Next:</p><ol type="1">
<li>Now that ERPC client is compiling, get the python server instantiated</li>
<li>Add a simple TempAlarm invocations from evb to python.</li>
<li>Profit! Or, more realistically, implement a bulk dump of an audiobuffer.</li>
<li>Can we get rid of all the #ifdef DEBUG-style stuff and make it more inline? e.g. use a macro to only dump if a DEFINE is enabled?</li>
</ol>
<h2><a class="anchor" id="autotoc_md18"></a>
Doozy of a Bug</h2>
<p >OK, so the 'don't really have a usb test' above turned out to be a problem. USB wasn't working at all, for the following reasons:</p><ol type="1">
<li>I wasn't calling the usb_service task (needs to be called in app loop)</li>
<li>Missing src files popped up when I added that.</li>
<li>TinyUSB needed a missing define, added that to makefile</li>
<li>Malloc and TinyUSB weren't getting along. If I did a malloc before initializing USB, nothing happened<ol type="a">
<li>This was a doozy of a bug. It turns out FreeRTOS malloc assumes the task manager has been initialized, which sets, among other things, a variable for tracking nested entry/exit of critical regions, during which interrupts are disabled. If the variable wasn't initialized, it disabled interrupts without complaint, but it didn't reenable them.</li>
<li>My solution was to create pvTasklessPort Malloc and vTasklessFree, and modify the original functions to only suspend/resume tasks if a new parameter was set.</li>
</ol>
</li>
</ol>
<p >TLDR: remember that heap_4.c has been modified, and portable.h! Also, when we add task support to NS, we need to add a config variable to ns-malloc that calls the right malloc/free.</p>
<p >Before I was derailed by Mr. Doozy, I made some progress on ERPC, researching the python endpoint. I switched to the matrix_multiple example which is simpler than tempalarm and closer to what we need anyway.</p>
<p >Now that I have this kind of working, go back to New Next step 2, above.</p>
<p >Regarding nests: we really need an upgrade mechanism (record date of nest creation, look for files in the nest that are newer to that so might get overridden, warn if I find any (maybe back them up automatically))</p>
<h2><a class="anchor" id="autotoc_md19"></a>
New new next</h2>
<p >Quick status: kind of have ERPC server/client talking. Server sees RPC after a couple of tries from client, and sees the right data. Eventually it starts getting CRC errors. The RPC response is all zeros on client side.</p><ol type="1">
<li>Debug why it takes a few requests.<ol type="a">
<li>Clue: the read after the request right doesn't seem to get any data. It could be that the server isn't seeing the first few.</li>
</ol>
</li>
<li>Add prints everywhere. Send/receive on client and server sides.</li>
<li>Fix send/receive status to return error if data doesn't match requested size</li>
<li>Figure out why crc errors start happening, probably some corruption going on.</li>
</ol>
<p >almost there!</p>
<h2><a class="anchor" id="autotoc_md20"></a>
Works!</h2>
<p >I was missing a flush in the usb send. Here is a list of cleanup items:</p><ol type="1">
<li>Add flush to ns-usb.h (DONE)</li>
<li>Get rid of all the prints I sprinkled everywhere</li>
<li>Put NS-specific erpc code in it's own directory for documentation purposes</li>
<li>Implement audio interface (instead of matrix multiply) (STARTED)</li>
<li>Move code into ns (see below)</li>
</ol>
<h2><a class="anchor" id="autotoc_md21"></a>
ERPC Flow</h2>
<ol type="1">
<li>NS/extern/erpc contains base code needed for ERPC clients, including erpc python</li>
<li>NS/ns-audio-dump - add ns-audio-dump.h and all erpc audio-specific code (including erpc for documentation)</li>
<li>NS/tools - add audio_erpc_example.py</li>
</ol>
<h2><a class="anchor" id="autotoc_md22"></a>
Status</h2>
<ol type="1">
<li>Cleaned up erpc, created an audio.erpc and a python app that is listening</li>
</ol>
<p >Next:</p><ol type="1">
<li>create new nest, massage code needed to only copy new stuff over</li>
<li>Modify <a class="el" href="main_8cc.html" title="Speech-to-Intent using NeuralSPOT.">main.cc</a> to call audio dump in real world inference loop</li>
<li>Copy erpc code over to ns as described above</li>
<li>Clean up <a class="el" href="main_8cc.html" title="Speech-to-Intent using NeuralSPOT.">main.cc</a> by breaking out into multiple files</li>
</ol>
<h2><a class="anchor" id="autotoc_md23"></a>
Latest Status</h2>
<p >RPC for audio works and has been checked in and merged. Now working on i2c drivers.</p>
<p >Next:</p><ol type="1">
<li>Get i2c mpu driver running DONE</li>
<li>Get i2c dumping via RPC running</li>
<li>Write decent documentation on all of that</li>
<li>Start clearing out my small item backlog</li>
</ol>
<h1><a class="anchor" id="autotoc_md24"></a>
NS Upgrades and Versions</h1>
<p >NS is changing often, including API-impacting changes, and won't stabilize for a while. Even after we're 'stable', we need a way to track major and minor changes, and an upgrade path.</p>
<h2><a class="anchor" id="autotoc_md25"></a>
Versioning</h2>
<p >Do we do an overall NS version, or do we version the individual libraries, or what? Having only the overall version means that your code may be impacted by NS changes that you don't care about. Having per-component versions adds complexity (both to user code and to our maintenance - what versions work with what?) How do we handle extern versions? Do we allow mix-and-match? That would mean that for new versions of TF, for example, I would have to add support for that to older versions of NS.</p>
<h3><a class="anchor" id="autotoc_md26"></a>
Proposal</h3>
<ul>
<li>For now, only latest version of NS is supported (I don't want to start adding #ifdefs everywhere)</li>
<li>New extern versions force new version of NS <em>GAH</em>, this is a pain. I'm going to punt to team for input/discussion.</li>
</ul>
<h2><a class="anchor" id="autotoc_md27"></a>
Upgrades</h2>
<p >This is primarily a nest thing. When you want to pull the latest NS code into an existing nest, how do you do it? Almost no src (other than headers) is copied over - basically just the stuff in example/src. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.2 </li>
  </ul>
</div>
</body>
</html>
